'''
This code produces difference-in-difference plots for policy interventions in Florida, Texas, and Washington. 
Each state is compared to the rest of the United States in each plot

'''
import pandas as pd
import numpy as np
from plotnine import *
import gzip

### Reading in data 

df = pd.read_parquet('merged_data.gzip')
df.head()

##Processing data 
df['Deaths'] = df['Deaths'].astype('float')
df['POPESTIMATE2010'] = df['POPESTIMATE2010'].astype('float')
df.drop(['COUNTY', 'FIPS'], axis = 1)

##Collapsing counties into states
grouped = df.groupby(['STATE', 'YEAR'], as_index=False).sum()
grouped.head()

### Calculating per capita deaths.
grouped['DeathsPerCapita'] = grouped['Deaths']/grouped['POPESTIMATE2010']
    
###Start by subsetting data by years. The analysis will be completed using all available data for that specific area. 
###The following function subsets data by years. 

def year_subset(df, start, end) : 

    boolean_years = (df['YEAR'] > start) & (df['YEAR'] <= end)
    filtered_data = df[boolean_years]
    return(filtered_data)
    
    
###This function should produce difference in difference plots

def diff_in_diff(data, state, year_change, response):
    data['InState'] = data['STATE']==state
    data_before = year_subset(data, 2006, year_change)
    data_after = year_subset(data, year_change, 2012)
  
    before = (ggplot(data_before, aes(x='YEAR', y= response, group = 'InState')) + geom_line(alpha=.5) + geom_point())
    after = (ggplot(data_after, aes(x='YEAR', y= response, group = 'InState')) + geom_line(alpha=.5) + geom_point())
    print(before)
    print(after)
   
    
diff_in_diff(grouped, 'AZ', 2010, 'DeathsPerCapita')
    
