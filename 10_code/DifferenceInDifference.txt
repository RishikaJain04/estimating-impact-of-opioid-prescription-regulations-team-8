'''
This code produces difference-in-difference plots for policy interventions in Florida, Texas, and Washington. 
Each state is compared to the rest of the United States in each plot

'''
import pandas as pd
import numpy as np
from plotnine import *
import gzip

### Reading in data 

df = pd.read_parquet('merged_data.gzip')
df.head()

##Processing data. No longer needed with waht we are using now. 
#df['Deaths'] = df['Deaths'].astype('float')
#df['POPESTIMATE2010'] = df['POPESTIMATE2010'].astype('float')
#df.drop(['COUNTY', 'FIPS'], axis = 1)


### Calculating per capita Drugs

df['DrugsPerCapita'] = df['MME_Calculated']/df['population']
    
    
###Start by subsetting data by years. The analysis will be completed using all available data for that specific area. 
###The following function subsets data by years. 

def year_subset(df, start, end) : 

    boolean_years = (df['YEAR'] > start) & (df['YEAR'] <= end)
    filtered_data = df[boolean_years]
    return(filtered_data)
    
    
###This function produces difference in differnce plots. You can specify the year of the policy and the variable you're interested in. 

def diff_in_diff(data, state, year_change, response):
    data['InState'] = data['STATE']==state
    data_grouped= data.groupby(['YEAR'], as_index=False).mean()
    data_grouped.head()
    data_before = year_subset(data_grouped, 2006, year_change)
    data_before = data_before.groupby('YEAR', as_index=False).mean()
    data_after = year_subset(data_grouped, year_change, 2020)
    data_after = data_after.groupby('YEAR', as_index=False).mean()

    before =(ggplot(data_before, aes(x='YEAR', y= response, group = 'InState')) + geom_line(alpha=.5) + geom_point()+ggtitle('Before Intervention'))
    after = (ggplot(data_after, aes(x='YEAR', y= response, group = 'InState')) + geom_line(alpha=.5) + geom_point()+ggtitle('After Intervention'))
    print(before)
    print(after)
   
    

    
